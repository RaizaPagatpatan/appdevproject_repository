{% extends "navbar_student.html" %}
{% load static %}
{% load custom_filters %}

<head>

    {% block title %}
    Student Home
    {% endblock %}

    {% block styles %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/student_homeStyle.css' %}">
    {% endblock %}
</head>


<body>
{% block content %}
    <main>
        <div class="contain-all">
            <section class="textpost-contain">
                <h2 id="a-title">Announcements</h2>
                <div class="announce">
                    <p>WIP</p>

                    <div>
                        <p> <img class="emptyImg" src="{% static 'images/empty.png' %}" alt="Empty" width="25%"> </p>
                    </div>
                </div>
            </section>

            <section class="main-contain">
                <h2 id="e-title">Events from Organizations You Follow</h2>
                <div class="event-con">
                    {% if custom_events %}
                        {% for ce in custom_events %}
                            <div class="event">
                                <div class="event-header">
                                    <div class="pfp">
                                        <img src="{{ ce.profile_pic.url }}" alt="{{ ce.organizer }} Profile Pic">
                                    </div>
                                    <div class="info">
                                        <a href="{% url 'org_profile' org_id=ce.organizer.user_id %}"><p><strong>{{ ce.organizer }}</strong></p></a>
                                    </div>
                                </div>

                                <div class="content">
                                    <div class="pubmat">
                                        {% if ce.images %}
                                            <img src="{{ ce.images.url }}" alt="{{ ce.organizer }} pubmat">
                                        {% else %}
                                            <img src="{% static 'images/empty.png' %}" alt="Placeholder">
                                        {% endif %}
                                    </div>

                                    <div class="content-txt">
                                        <p class="title">
                                            <a href="#" onclick="openViewEventLightbox('{{ ce.eventID }}')" class="ce-link">
                                                {{ ce.eventName }}
                                            </a>
                                        </p>
                                        <p>Start: {{ ce.start }}</p>
                                        <p>End: {{ ce.end }}</p>
                                        <p>Location: {{ ce.location }}</p>
                                        <p>Details: {{ ce.details }}</p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                    {% else %}
                        <div class="placeholder">
                            <p> <img class="emptyImg" src="{% static 'images/empty.png' %}" alt="Empty" width="25%"> </p>
                        </div>
                    {% endif%}
                </div>
            </section>

            <section class="bookmark-contain">
                <h2 id="b-title">Bookmarked Events</h2>
                <div class="ongoing">
                    {% if bookmarks %}
                        {% for bookmark in bookmarks %}
                            <a href="#" onclick="openViewEventLightbox('{{ bookmark.event.eventID }}')" class="bookmark-link">
                                <div class="bookmarks" >
                                    <div class="eve-name">{{ bookmark.event.eventName }}</div>
                                    <div class="deets">
                                        <p>Organizer: {{ bookmark.event.organizer.organization_name }}</p>
                                        <p>Starts on: <br>
                                            {{ bookmark.event.start|date:"F j, Y" }}<br>
                                            {{ bookmark.event.start|time:"g:i A" }}
                                        </p>
                                    </div>
                                </div>
                            </a>
                        {% endfor %}
                    {% else %}
                        <div>
                            <p> <img class="emptyImg" src="{% static 'images/empty.png' %}" alt="Empty" width="25%"> </p>
                        </div>
                    {% endif%}
                </div>
            </section>
        </div>

        <!-- Lightbox content for each event added sa org -->

        {% for event in events %}
            <div id="{{ event.eventID }}Lightbox" style="display: none;" class="lightbox">
                <div class="lightbox-content">
                    {% if event.images %}
                        <img src="{{ event.images.url }}" alt="{{ event.eventName }}">
                    {% else %}
                        <!-- Placeholder image sa empty -->
                        <img src="{% static 'images/empty.png' %}" alt="Placeholder">
                    {% endif %}
                    <!-- Other contents here..... -->
                    <p>{{ event.eventName }}</p>
                    <p>Organizer: {{ event.organizer }}</p>
                    <p>Start: {{ event.start }}</p>
                    <p>End: {{ event.end }}</p>
                    <p>Location: {{ event.location }}</p>
                    <p>Details: {{ event.details }}</p>

                    <div class="action-btns">
                        <div class="bookmark-contain">
                            {%  if request.session.user_id|has_bookmarked:event.eventID %}
                                <form method="post" action="{% url 'remove_bookmark_event' event_id=event.eventID %}">
                                    {% csrf_token %}
                                    <button type="submit">Remove from bookmarks</button>
                                </form>
                            {% else %}
                                <form method="post" action="{% url 'bookmark_event' event_id=event.eventID %}">
                                    {% csrf_token %}
                                    <button type="submit">Add to bookmarks</button>
                                </form>
                            {% endif %}
                        </div>

                        <div class="options-container">
                        <div class="options-button
                                {% if event.rsvp_yes.exists %} yesclass_txt
                                {% elif event.rsvp_no.exists %} noclass_txt
                                {% else %} non_txt {% endif %}"
                                onclick="toggleOptions()">
                            <button id="rsvpButtonText">
                                {% if event.rsvp_yes.exists %}
                                    Going
                                {% elif event.rsvp_no.exists %}
                                    Not Going
                                {% else%}
                                    RSVP
                                {% endif %}
                            </button>
                        </div>

                            <div class="options-menu">
                                <div class="option
                                    {% if event.rsvp_yes.exists %} yesclass
                                    {% else %} non {% endif %}"
                                    onclick="RSVPyes({{ event.eventID }}, this)">
                                    <button id="gobtn">Going</button>
                                </div>

                                <hr>

                                <div class="option
                                    {% if event.rsvp_no.exists %} noclass
                                    {% else %} non {% endif %}"
                                    onclick="RSVPno({{ event.eventID }}, this)">
                                    <button>Not Going</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="closeLightbox('{{ event.eventID }}Lightbox')">X</button>
            </div>
        {% endfor %}

<!--        <script src="{% static 'js/script.js' %}"></script>-->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- Lightbox openscript uwu -->
    <script>
        // Function to open the event lightbox
        function openViewEventLightbox(eventID) {
            console.log("Button clicked");  // Add this line for debugging
            document.getElementById(eventID + "Lightbox").style.display = "block";
        }

        // Function to close the event lightbox
        function closeLightbox(lightboxID) {
            document.getElementById(lightboxID).style.display = "none";
        }

        //Function to open optionsMenu when RSVP button is clicked
        let currentOptionsMenu = null;

        function toggleOptions() {
            const optionsMenu = event.currentTarget.nextElementSibling;

            // Close the previously open options menu
            if (currentOptionsMenu && currentOptionsMenu !== optionsMenu) {
                currentOptionsMenu.classList.remove('show');
            }

            // Toggle the options menu of the clicked post
            optionsMenu.classList.toggle('show');
            currentOptionsMenu = optionsMenu;
        }

        // Close the menu if the user clicks outside of it
        document.addEventListener('click', function (event) {
            const optionsContainer = document.querySelector('.options-container');
            const optionsMenus = document.querySelectorAll('.options-menu');

            if (!optionsContainer.contains(event.target)) {
                // Loop through all options menus and close them if they are not contained in the clicked element's parent hierarchy
                optionsMenus.forEach(function (optionsMenu) {
                    if (!optionsMenu.closest('.options-container').contains(event.target)) {
                        optionsMenu.classList.remove('show');
                    }
                });
            }
        });

        function RSVPyes(eventId, element) {
            // Get the CSRF token from the cookie
            const csrftoken = getCookie('csrftoken');

            $.ajax({
                url: '/rsvp_yes/' + eventId + '/',
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    // Update CSS and remove click event
                    $(element).removeClass('noclass').addClass('yesclass');

                    // Refresh the page
                    location.reload();
                },
                error: function (error) {
                    console.error('Error in selecting response', error);
                }
            });
        }

        function RSVPno(eventId, element) {
            // Get the CSRF token from the cookie
            const csrftoken = getCookie('csrftoken');

            $.ajax({
                url: '/rsvp_no/' + eventId + '/',
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken },
                success: function (data) {
                    // Update CSS and remove click event
                    $(element).removeClass('yesclass').addClass('noclass');

                    // Refresh the page
                    location.reload();
                },
                error: function (error) {
                    console.error('Error in selecting response', error);
                }
            });
        }

        // Function to get the CSRF token from the cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Check if the cookie name matches
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

    </script>
    </main>
{% endblock %}
</body>
